"use strict";var css=require("css"),CleanCSS=require("clean-css"),matchMedia=require("./matchMedia");function shouldBeExcluded(a,b){if(!a.rules)return!1;var c=a.rules.map(function(a){var b=a.selectors;return b.join(",")});return b.some(function(a){return c.includes(a)})}module.exports=function(a){var b=a.cssSource,c=a.mediaOptions,d=a.ignoredSelectors,e=a.units,f={},g={},h=css.parse(b).stylesheet.rules,i={common:[],desktop:[],mobile:[],tabletPortrait:[],tabletLandscape:[],tablet:[]},j=0<d.length;return h.forEach(function(a){var b=matchMedia({mediaQuery:a.media,mediaOptions:c,units:e}),f=b.isDesktop,g=b.isTablet,h=b.isTabletLandscape,k=b.isTabletPortrait,l=b.isMobile;"media"===a.type?j&&shouldBeExcluded(a,d)?i.common.push(a):(f&&i.desktop.push(a),h&&(i.tablet.push(a),i.tabletLandscape.push(a)),k&&(i.tablet.push(a),i.tabletPortrait.push(a)),l&&i.mobile.push(a),!f&&!g&&!l&&i.common.push(a)):i.common.push(a)}),Object.keys(i).forEach(function(a){f[a]=[],g[a]=[];var b=i[a];b.forEach(function(b){var c=b.media,d=b.rules,e=b.position,g=f[a],h=g.length?g[g.length-1].media:null,i=f[a].map(function(a){var b=a.media;return b}).indexOf(c);c&&h===c?f[a][i].rules=f[a][i].rules.concat(d):f[a].push(b)});var c=css.stringify({type:"stylesheet",stylesheet:{rules:f[a]}});g[a]=new CleanCSS().minify(c).styles}),g};